<!DOCTYPE html>
<html>
  <head>
    {% for dict in results %}
    <meta id="highestBid" data-name="{{dict['highestBid']}}" >
    <meta id="buyNow" data-name2="{{dict['buyNow']}}" >

    {% endfor %}
    <title>Buyers Page</title>
  </head>
  <body>
    {% include 'header.html' %}
    {% for dict in results %}
      <h1>{{dict["title"]}}</h1>
      <img src="{{images[dict['images']]}}" width="225" height="160"></img>
      <div>Authors: {{dict["authors"]}}</div>
      <div>ISBN: {{dict["isbn"]}}</div>
      <div>Course: {{dict["crscode"]}} -- {{dict["crstitle"]}}</div>
      <hr>
      <div>Seller: {{dict["sellerId"]}}</div>
      <div>Condition: {{dict["condition"]}}</div>
      <div>Lowest Ask: {{dict["minPrice"]}}</div>
      <div>Highest Bid: {{dict["highestBid"]}}</div>
      <div>Buy Now Price: {{dict["buyNow"]}}
           {% set message = "Are you sure you would like to buy this item at the Buy Now Price?" %}
           <form action="/buyerPage?bookid={{uniqueId}}&buyNow={{dict['buyNow']}}" method="POST" id="buyNowForm">
              <button type="submit" form="buyNowForm" onclick="confirm({{message}})" value="Submit">
              Buy Now
              </button>
           </form>
      </div>
    {% endfor %}
    <div>
      <div>Make a Bid:
        <form action="profilePage" method="POST" id="submitBidForm">
        <input type="text" name="bid" id="userBid" /> (example input: 19.99)
        </form>
      </div>
      <button
        form="submitBidForm"
        onclick="return verifyBid();"
        style="visibility: hidden;">

    </button>
     
    </div>

    <link href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="Stylesheet"></link>
    <script src= "https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"> </script>
    <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.js" ></script>
    <script>

      'use strict';

      function verifyBid(){
        let bid = $(userBid).val();
        let highestBid = $('#highestBid').data('name');
        let buyNow = $('#buyNow').data('name2');

        console.log("inside the function; highestBid:", highestBid);
        console.log("inside the function; buyNow:", buyNow);
        // higher than buy now price 
        if (bid > buyNow) {
          if (confirm("Are you sure you want to bid higher than the buy now price?")){
            alert("Congratulations!  You have succesfully placed your bid :)!")
            return true;
          }
          else{
            return false;
          }
           
        } else if (bid < highestBid){ // less than highest bid
          if (confirm('Are you sure you would like to bid this amount, it is lower than the highest current bid?')){
            alert("Congratulations!  You have succesfully placed your bid :)!")
            return true;
          }
          else{
            return false;
          }
        } else {
          if (confirm('Are you sure you would like to bid this amount?')){
            alert("Congratulations!  You have succesfully placed your bid :)!")
            return true;
          }
          else{
            return false;
          }
        }

        return true;
      }
      function handleResponse(response){
        // return array depending on search

        try
        {
          let results = response;

                  // call jQuery autocomplete on said list
          $("#searchQuery").autocomplete({
            source: results
          });

        }
        catch(e){
          console.log("error: ", e);
        }


      }


      let request = null;

      function getResults(){

        let searchType = $('#searchType1').val();
        searchType = encodeURIComponent(searchType);
        console.log("searchType: ", searchType);

        let query = $('#searchQuery').val();
     
        query = encodeURIComponent(query);
        console.log("query: ", query);

        if (searchType !== '' || searchType !== null){
          if(query !== null || query.trim() !== ''){
            let url = 'autoComplete?searchType=' + searchType + "&query=" + query
          
            if (request != null) {
				      request.abort();
			      }

			      request = $.ajax(
				      {
					      type: 'GET',
					      url: url, 
					      success: handleResponse
				      }

			      );
          }
        }

		}
      function setup(){
        $('#searchQuery').focus();
        $('#searchQuery').on('input', getResults);
      }
      $('document').ready(setup);
    </script>




    {% include 'footer.html' %}
  </body>
</html>
