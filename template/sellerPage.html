<!DOCTYPE html>
<html>
  <head>
    <title>Seller's Page</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" 
          type="text/css"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

    <style>
      .jumbotron{
          background-color:#F0AD4E;
          color:black;
      }
    </style>
  </head>
  
  <body>
    {% include 'header.html' %}

    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="jumbotron">

            <h1 class="sellerHeading">Add a New Listing</h1>

            <form action="/sellerPage" method="POST" id="submitBookForm" enctype="multipart/form-data">
              <div class="row">
                <div class="col-md-8">
                  <label for="inputTitle" class="form-label">Book Title</label>
                  <input type="text" class="form-control" name="title" id="inputTitle" placeholder="Ex: The Practice of Programming" required>
                  <div class="invalid-feedback">
                    Book title is required
                  </div>
                </div>

                <div class="form-group col-md-4">
                  <label for="inputISBN" class="form-label">ISBN</label>
                  <input type="text" class="form-control" name="isbn" id="inputISBN" required>
                  <div class="invalid-feedback">
                    ISBN is required
                  </div>
                </div>
              </div>

              <div class="row">
                <input type="hidden" name="count" value="1"/>
                <div class="form-group col-md-4">
                  <label class="control-label" for="field1">Authors</label>
                  <div class="controls" id="profs"> 
                    <form class="input-append">
                      <div id="field">
                        <input autocomplete="off" class="input" id="authorField1" name="prof1" type="text" placeholder="Type something" data-items="8"/>
                        <button id="b1" class="btn add-more" type="button">+</button>
                      </div>
                    </form>
                    <br>
                    <small>Press + to add another author</small>
                  </div>
                </div>
                <!--div class="form-group col-md-4">
                  <label for="inputAuthors" class="form-label">Authors</label>
                  <input type="text" class="form-control" name="authors" id="inputAuthors" placeholder="Ex: Brian Kernighan">
                </div-->
              </div>

              <div class="row">
                <div class="form-group col-md-6">
                  <label for="inputCourseTitle" class="form-label">Course Title</label>
                  <input type="text" class="form-control" name="crstitle" id="inputCourseTitle" placeholder="Ex: Advanced Programming Techniques">
                </div>

                <div class="form-group col-md-2">
                  <label for="inputCode" class="form-label">Course Code</label>
                  <input type="text" class="form-control" name="crscode" id="inputCode" placeholder="Ex: COS 333" required>
                  <div class="invalid-feedback">
                    Course Code is required
                  </div>
                </div>

                <div class="form-group col-md-4">
                  <label for="inputCondition" class="form-label">Condition</label>
                  <select id="inputCondition" name="bookCondition" class="form-control">
                    <option selected>Choose...</option>
                    <option>Poor</option>
                    <option>Slightly Worn</option>
                    <option>Good</option>
                    <option>Brand New</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="form-group col-md-6">
                  <label for="inputMin" class="form-label">Minimum Price</label>
                  <input type="number" class="form-control" name="minPrice" id="inputMin" required>
                  <div class="invalid-feedback">
                    Min Price is required
                  </div>
                </div>
              
                <div class="form-group col-md-6">
                  <label for="inputBuy" class="form-label">Buy Now Price</label>
                  <input type="number" class="form-control" name="buyNow" id="inputBuy" required>
                  <div class="invalid-feedback">
                    Buy Now Price is required
                  </div>
                </div>
              </div>

              <h2>Add Images</h2>
              <!--input type="file" accept="image/*" name="image1">
              <input type="file" accept="image/*" name="image2">
              <input type="file" accept="image/*" name="image3"-->

              <!--script src="https://res.cloudinary.com/dxfq3iotg/raw/upload/v1569993029/imgur.js"></script-->
              <div class="d-flex justify-content-center mt-100">
                <div class="row ">
                  <div class="col-md-12">
                    <div class="dropzone uploadfuzone fuzone">
                      <div class="row">
                        <div class="col-md-8">
                          <div class="fu-text"> 
                            <span><i class="fa fa-picture-o"></i> Click here or drop file to upload</span> 
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="snippet_image_div"> 
                          </div>
                        </div>
                      </div> 
                      <input type="file" class="input" accept="image/*">
                    </div>
                    <div class="status">
                      </div>
                      <div class="text-center"><span class="imgur-link"></span>
                    </div>
                  </div>
                </div>
              </div>
              <br> 
              <button type="submit"
                      class="btn orange" 
                      form="submitBookForm"
                      onclick="return verifyListing();"
                      value="Submit"> Submit
              </button> 
            </form>
          </div>
        </div>
      </div>
    </div>

    {% include 'footer.html' %}

    <link href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet"></link>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"> </script>
    <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.js" ></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
    <script>

      'use strict';

      function verifyListing(){
        
        // make sure none of the required entrys are null
        // if none are null ask if they are sure they want to list - if yes do success listing

        let isbn = $('#inputISBN').val();
        console.log("isbn: ", isbn);
        let title = $('#inputTitle').val();
        console.log("title: ", title);
        let authors = $('#authorField1').val();
        console.log("authors: ", authors);
        let crscode = $('#inputCode').val();
        console.log("crscode: ", crscode);
        let crstitle = $('#inputCourseTitle').val();
        console.log("crstitle: ", crstitle);
        let minPrice = $('#inputMin').val();
        console.log('Min price: ', minPrice);
        minPrice = parseFloat(minPrice, 10.00);
        console.log('Min price: ', minPrice);
        if (Number.isNaN(minPrice)){
          alert('All required fields are not filled, please make sure you complete all required fields!');
          return false;
        } 
        let buyNow = $('#inputBuy').val();
        buyNow = parseFloat(buyNow, 10.00);
        if (Number.isNaN(buyNow)){
          alert('All required fields are not filled, please make sure you complete all required fields!');
          return false;
        }
        console.log('buyNow: ', buyNow);
        let condition = $('#inputCondition').val();
        console.log("inputCondition: ", condition);

        if (buyNow < minPrice){
          alert('Your buy now price is less than the minimum ask, please update!')
          return false;
        }


        // missing value checks
        if (isbn == null || title == null || authors == null || crscode == null 
        || crstitle == null || minPrice == null || buyNow == null || condition == null){
          console.log("in first if statement");
          alert('All required fields are not filled, please make sure you complete all required fields!');
          return false;
        } 
        if (isbn.trim() === '' || title.trim() === '' || authors.trim() === '' || crscode.trim() === '' ||
          crstitle.trim() === '') {
          alert('All required fields are not filled, please make sure you complete all required fields!');
          return false;
        } 
        
        // negative values
        if (minPrice < 0.0 || buyNow < 0.0){
          alert("Incorrect minimum price or buy now price, values have to be greater than zero");
          return false;
        }

        // incorrect isbn
        let numHyphen = 0;
        for (i = 0; i < isbn.length; i++){
          if ((/[a-zA-Z]/).test(isbn.charAt(i))){
            if(isbn.charAt(i) === '-'){
              numHyphen += 1;
            }
              alert("Incorrect isbn, isbn can only be integers seperated by a hyphen '-'");
              return false;
        }
        if (numHyphen > 4){
          alert("Incorrect isbn value, too many hyphens only allowed to have four");
          return false;
        }
        }
        
        if(true){
          if (confirm('Are you sure you would like to post this listing?')){
            alert("Congratulations!  You have succesfully listed an tem :)!");
            return true;
          }
          else{
            return false;
        }
        }




      }


      function handleResponse(response){
        // return array depending on search

        try
        {
          let results = response;

                  // call jQuery autocomplete on said list
          $("#searchQuery").autocomplete({
            source: results
          });

        }
        catch(e){
          console.log("error: ", e);
        }


      }


      let request = null;

      function getResults(){

        let searchType = $('#searchType1').val();
        searchType = encodeURIComponent(searchType);
        console.log("searchType: ", searchType);

        let query = $('#searchQuery').val();
     
        query = encodeURIComponent(query);
        console.log("query: ", query);

        if (searchType !== '' || searchType !== null){
          if(query !== null || query.trim() !== ''){
            let url = 'autoComplete?searchType=' + searchType + "&query=" + query
          
            if (request != null) {
				      request.abort();
			      }

			      request = $.ajax(
				      {
					      type: 'GET',
					      url: url, 
					      success: handleResponse
				      }

			      );
          }
        }

		}
      function setup(){
        $('#searchQuery').focus();
        $('#searchQuery').on('input', getResults);
      }
      $('document').ready(setup);
    </script>
  </body>
</html>
